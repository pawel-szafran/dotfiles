# Plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'laktak/extrakto'
set -g @extrakto_filter_order 'url path line word all'
set -g @plugin 'Morantron/tmux-fingers'
set -g @plugin 'roosta/tmux-fuzzback'
set -g @fuzzback-popup 1
set -g @fuzzback-popup-size '80%'

# Auto-install TPM if not present
if "test ! -d ~/.config/tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm && ~/.config/tmux/plugins/tpm/bin/install_plugins'"

# Prefix
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# General
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"
set -ga terminal-features "xterm-ghostty:sync"
set -g mouse on
set-environment -g LESS "-R --mouse --wheel-lines=3"
set -g base-index 1
set -g pane-base-index 1
set -g renumber-windows on
set -g detach-on-destroy off
set-hook -g client-session-changed "run-shell -b '~/.config/tmux/scripts/kill-numeric-sessions.sh'"
set -g display-panes-time 3000
set -g allow-passthrough on

# Everforest Dark Medium palette
%hidden EF_BG="#2d353b"
%hidden EF_BG1="#343f44"
%hidden EF_FG="#d3c6aa"
%hidden EF_GREY0="#7a8478"
%hidden EF_GREY1="#859289"
%hidden EF_GREEN="#a7c080"
%hidden EF_AQUA="#83c092"

# Status bar - subtle separator style
set -g status 2
set -g status-position top
set -g status-format[1] "#[fill=terminal]"
set -g status-justify left
set -g status-style "fg=#{EF_GREY0},bg=#{EF_BG1}"

# Left: session (inverted) + windows
set -g status-left "#[fg=#{EF_BG},bg=#{EF_GREEN}] #S #[default] "
set -g status-left-length 50
set -g window-status-format "#[fg=#{EF_GREY0}] #W "
set -g window-status-current-format "#[fg=#{EF_GREEN}] #W "
set -g window-status-separator ""

# Right: zoom indicator + current directory
set -g status-right-length 50
set -g status-right "#{?window_zoomed_flag,#[fg=#{EF_AQUA}]â¦¿  ,}#[fg=#{EF_GREY0}]#(~/.config/tmux/scripts/truncated-path.sh '#{pane_current_path}')"

# Pane borders - subtle
set -g pane-border-style "fg=#{EF_GREY0}"
set -g pane-active-border-style "fg=#{EF_GREEN}"

# Message/command style
set -g message-style "fg=#{EF_BG},bg=#{EF_AQUA}"
set -g message-command-style "fg=#{EF_BG},bg=#{EF_AQUA}"

# Splits (keep current path)
unbind %
unbind '"'
bind v split-window -h -c "#{pane_current_path}"
bind s split-window -v -c "#{pane_current_path}"

# Pane navigation (Alt+hjkl, no prefix needed)
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# Pane management
bind z resize-pane -Z
bind b break-pane

# Window navigation
bind h previous-window
bind l next-window
bind H swap-window -t -1\; select-window -t -1
bind L swap-window -t +1\; select-window -t +1
bind w display-popup -w 40% -h 40% -E "~/.config/tmux/scripts/switch-window.sh"

# Window management
bind n new-window -c "#{pane_current_path}"
bind r command-prompt 'rename-window %%'

# Agent overview
bind a display-popup -w 60% -h 50% -E "~/.config/tmux/scripts/agents.sh"

# Kill pane/window/session
bind x kill-pane
bind X kill-window
bind q display-popup -E -w 60% -h 40% "~/.config/tmux/scripts/kill-session.sh"

# Session management
bind N command-prompt 'new-session -s %%'
bind Space display-popup -w 40% -h 40% -E "~/.config/tmux/scripts/switch-session.sh"
bind Enter display-popup -w 40% -h 40% -E "~/.config/tmux/scripts/switch-session-project.sh"
bind R command-prompt 'rename-session %%'

# Project management
bind g display-popup -w 60% -h 60% -E "~/.config/tmux/scripts/pr-review.sh"
bind p display-popup -w 60% -h 60% -E "~/.config/tmux/scripts/project-picker.sh"
bind P display-popup -w 40% -h 40% -E "~/.config/tmux/scripts/project-here.sh"
bind o display-popup -w 40% -h 40% -E "~/.config/tmux/scripts/favorites.sh"

# Floating popups
bind t display-popup -E -w 80% -h 80% -d "#{pane_current_path}" -- fish
bind f new-window -c "#{pane_current_path}" -- yazi

# Pass through Shift+Enter (CSI u sequence)
bind -n S-Enter send-keys Escape "[13;2u"

# Vi copy mode
setw -g mode-keys vi
bind / copy-mode
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe "pbcopy"

# Clear scrollback + screen
bind k send-keys -R \; clear-history \; send-keys Enter

# Reload config
bind C-r source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded"

# Initialize TPM (keep at bottom)
run '~/.config/tmux/plugins/tpm/tpm'
